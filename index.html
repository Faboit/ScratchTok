<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ScratchTok Ultra — Infinite Feed</title>
<style>
:root {
    --bg: #050505;
    --accent: #ff0050;
    --secondary: #00f2ea;
    --glass: rgba(255,255,255,0.1);
    --text: #ffffff;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, sans-serif;
    overflow: hidden;
}

#feed {
    height: 100vh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
}
#feed::-webkit-scrollbar { display: none; }

.slide {
    height: 100vh;
    width: 100vw;
    scroll-snap-align: start;
    display: flex;
    justify-content: center;
    background: #000;
    position: relative;
}

.project-container {
    width: 100%;
    height: 100%;
    /* max-width removed so it can expand fully */
    background: #111;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
}

iframe {
    width: 100%;
    height: 100%;
    border: none;
    aspect-ratio: auto; /* unlocked ratio */
    z-index: 1;
}

.overlay {
    position: absolute;
    inset: 0;
    z-index: 10;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 20px;
    background: linear-gradient(0deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 40%);
}

.side-bar {
    position: absolute;
    right: 12px;
    bottom: 100px;
    z-index: 20;
    display: flex;
    flex-direction: column;
    gap: 20px;
    pointer-events: auto;
}

.action-btn {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.icon-circle {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--glass);
    display: grid;
    place-items: center;
    backdrop-filter: blur(10px);
    font-size: 22px;
}

.action-label { font-size: 12px; }

.author-tag {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
}

.author-tag span {
    font-size: 14px;
    font-weight: 400;
    color: #aaa;
}

.project-title {
    font-size: 14px;
    line-height: 1.4;
    max-width: 80%;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

#loader {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: none;
    z-index: 100;
}

.heart-pop {
    position: absolute;
    font-size: 100px;
    color: var(--accent);
    animation: pop 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 200;
}

@keyframes pop {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
}
</style>
</head>
<body>

<div id="loader">FETCHING DATA...</div>
<div id="feed"></div>

<script>
const CONFIG = {
    PAGE_SIZE: 12,
    PROXY: 'https://api.allorigins.win/get?url=',
    TURBOWARP_OPTS: '' // unlocked fps, no 60fps cap
};

const state = {
    offsets: { trending: 0, popular: 0, recent: 0 },
    seen: new Set(JSON.parse(localStorage.getItem('seen_projects') || '[]')),
    isFetching: false
};

const feed = document.getElementById('feed');
const loader = document.getElementById('loader');

async function apiRequest(url) {
    try {
        const r = await fetch(CONFIG.PROXY + encodeURIComponent(url));
        const j = await r.json();
        return JSON.parse(j.contents);
    } catch {
        return [];
    }
}

async function getProjects() {
    if (state.isFetching) return [];
    state.isFetching = true;
    loader.style.display = 'block';

    const urls = [
        `https://api.scratch.mit.edu/explore/projects?limit=${CONFIG.PAGE_SIZE}&offset=${state.offsets.trending}&mode=trending`,
        `https://api.scratch.mit.edu/explore/projects?limit=${CONFIG.PAGE_SIZE}&offset=${state.offsets.popular}&mode=popular`,
        `https://api.scratch.mit.edu/search/projects?limit=${CONFIG.PAGE_SIZE}&offset=${state.offsets.recent}&sort_by=created&q=*`
    ];

    const results = await Promise.all(urls.map(apiRequest));

    state.offsets.trending += CONFIG.PAGE_SIZE;
    state.offsets.popular += CONFIG.PAGE_SIZE;
    state.offsets.recent += CONFIG.PAGE_SIZE;

    loader.style.display = 'none';
    state.isFetching = false;

    return results.flat().filter(p => p && !state.seen.has(p.id));
}

function createSlide(project) {
    const slide = document.createElement('div');
    slide.className = 'slide';
    slide.dataset.id = project.id;

    slide.innerHTML = `
        <div class="project-container" id="container-${project.id}">
            <div class="overlay">
                <div class="author-tag">@${project.author.username} <span>• Follow</span></div>
                <div class="project-title">${project.title}</div>
            </div>
            <div class="side-bar">
                <button class="action-btn" onclick="like(this)">
                    <div class="icon-circle">❤️</div>
                    <span class="action-label">${num(project.stats?.loves || 0)}</span>
                </button>
                <button class="action-btn" onclick="window.open('https://scratch.mit.edu/projects/${project.id}')">
                    <div class="icon-circle">⭐</div>
                    <span class="action-label">${num(project.stats?.favorites || 0)}</span>
                </button>
            </div>
        </div>
    `;

    slide.addEventListener('dblclick', e => heart(e));
    return slide;
}

function inject(id) {
    const c = document.getElementById(`container-${id}`);
    if (!c || c.querySelector('iframe')) return;

    const i = document.createElement('iframe');
    i.src = `https://turbowarp.org/${id}/embed?${CONFIG.TURBOWARP_OPTS}&autoplay=true`;
    i.allow = 'fullscreen; autoplay';
    c.appendChild(i);

    state.seen.add(id);
    localStorage.setItem('seen_projects', JSON.stringify([...state.seen].slice(-200)));
}

const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
        const id = e.target.dataset.id;
        if (e.isIntersecting) inject(id);
        else e.target.querySelector('iframe')?.remove();
    });
}, { threshold: 0.7 });

async function loadMore() {
    const projects = await getProjects();
    projects.forEach(p => {
        const s = createSlide(p);
        feed.appendChild(s);
        observer.observe(s);
    });
}

function like(btn) {
    if (btn.dataset.liked) return;
    btn.dataset.liked = true;
    const l = btn.querySelector('.action-label');
    l.textContent = num(parseInt(l.textContent.replace(/,/g,'')) + 1);
}

function heart(e) {
    const h = document.createElement('div');
    h.className = 'heart-pop';
    h.textContent = '❤️';
    h.style.left = e.clientX - 50 + 'px';
    h.style.top = e.clientY - 50 + 'px';
    document.body.appendChild(h);
    setTimeout(() => h.remove(), 600);
}

function num(n) {
    if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
    if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
    return n;
}

feed.addEventListener('scroll', () => {
    if (feed.scrollHeight - (feed.scrollTop + feed.clientHeight) < 1000) {
        loadMore();
    }
});

loadMore();
</script>
</body>
</html>
