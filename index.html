<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>ScratchTok Ultra ‚Äî Personalized Feed</title>
    <style>
        :root {
            --bg: #050505;
            --accent: #ff0050;
            --glass: rgba(255,255,255,0.15);
            --text: #ffffff;
            --panel: #1a1a1a;
            --gradient: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 60%);
        }

        /* Themes */
        body.theme-oled { --bg: #000000; --panel: #0a0a0a; --accent: #ff0050; }
        body.theme-cyber { --bg: #0b0114; --panel: #1a0229; --accent: #00f2ea; --gradient: linear-gradient(0deg, rgba(11,1,20,0.95) 0%, rgba(11,1,20,0) 60%); }
        body.theme-light { --bg: #f0f2f5; --panel: #ffffff; --accent: #ff0050; --text: #000000; --glass: rgba(0,0,0,0.1); --gradient: linear-gradient(0deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 60%); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        #feed {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        #feed::-webkit-scrollbar { display: none; }

        .slide {
            height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            display: flex;
            justify-content: center;
            background: #000;
            position: relative;
        }

        .project-container {
            width: 100%;
            height: 100%;
            background: #111;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }

        .overlay {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            padding-bottom: 60px;
            background: var(--gradient);
        }

        /* Fixed Navigation Buttons */
        .nav-controls {
            position: fixed;
            right: 75px;
            bottom: 25px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            display: grid;
            place-items: center;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .nav-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.1); }

        .side-bar {
            position: absolute;
            right: 12px;
            bottom: 110px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.9); }

        .icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass);
            display: grid;
            place-items: center;
            backdrop-filter: blur(10px);
            font-size: 24px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .action-btn:hover .icon-circle { background: rgba(255,255,255,0.2); }

        /* Specific Button Styles */
        .open-btn-icon {
            background: linear-gradient(135deg, var(--accent), #ff4d80);
            box-shadow: 0 4px 15px rgba(255, 0, 80, 0.4);
        }

        .action-label { font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); color: white; }

        /* Read-only stats */
        .stat-display {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            gap: 5px;
            text-shadow: 0 1px 2px black;
        }

        .author-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            pointer-events: auto;
        }

        .pfp {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1.5px solid white;
            background: #333;
            object-fit: cover;
        }

        .author-tag {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .project-title {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.3;
            max-width: 80%;
            color: #fff;
            margin-top: 4px;
            word-wrap: break-word;
            text-shadow: 0 1px 5px rgba(0,0,0,0.8);
        }

        #settings-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: var(--glass);
            border: none;
            color: var(--text);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(10px);
            font-size: 18px;
        }

        #settings-panel {
            position: fixed;
            inset: 0;
            background: var(--panel);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 30px;
            overflow-y: auto;
            color: var(--text);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--glass);
            padding-bottom: 15px;
        }

        .setting-group {
            background: rgba(128,128,128,0.05);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--glass);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        select, input {
            padding: 8px;
            border-radius: 6px;
            background: var(--glass);
            color: inherit;
            border: 1px solid var(--glass);
        }

        #loader {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: bold;
            display: none;
            z-index: 150;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .algorithm-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 10px;
            z-index: 30;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
        }

        .heart-pop {
            position: absolute;
            font-size: 80px;
            pointer-events: none;
            z-index: 200;
            animation: pop 0.8s ease-out forwards;
        }

        @keyframes pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

<button id="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>

<div class="nav-controls">
    <button class="nav-btn" onclick="scrollFeed(-1)">‚ñ≤</button>
    <button class="nav-btn" onclick="scrollFeed(1)">‚ñº</button>
</div>

<div id="settings-panel">
    <div class="settings-header">
        <h1>Settings</h1>
        <button onclick="toggleSettings()" style="background:none; border:none; color:inherit; font-size:32px; cursor:pointer;">‚úï</button>
    </div>

    <div class="setting-group">
        <h3>Theme & Style</h3>
        <div class="setting-item">
            <label>Interface Theme</label>
            <select id="set-theme" onchange="updateSetting('theme', this.value)">
                <option value="dark">Standard Dark</option>
                <option value="oled">Pure OLED</option>
                <option value="cyber">Cyber Purple</option>
                <option value="light">Soft Light</option>
            </select>
        </div>
        <div class="setting-item">
            <label>Hide Labels</label>
            <input type="checkbox" id="set-hidebadges" onchange="updateSetting('hideBadges', this.checked)">
        </div>
    </div>

    <div class="setting-group">
        <h3>Simulator</h3>
        <div class="setting-item">
            <label>Player Engine</label>
            <select id="set-engine" onchange="updateSetting('engine', this.value)">
                <option value="turbowarp">TurboWarp</option>
                <option value="scratch">Official Scratch</option>
                <option value="penguinmod">PenguinMod</option>
            </select>
        </div>
        <div class="setting-item">
            <label>60 FPS Interpolation</label>
            <input type="checkbox" id="set-interp" onchange="updateSetting('interpolation', this.checked)">
        </div>
    </div>
</div>

<div id="loader">SEARCHING...</div>
<div id="feed"></div>

<script>
const DEFAULT_SETTINGS = {
    engine: 'turbowarp',
    hideBadges: false,
    interpolation: true,
    theme: 'dark',
    overlayOpacity: 90,
    loadAhead: 5
};

let settings = JSON.parse(localStorage.getItem('user_settings') || JSON.stringify(DEFAULT_SETTINGS));

const state = {
    likedTags: JSON.parse(localStorage.getItem('liked_tags') || '{}'),
    seen: new Set(JSON.parse(localStorage.getItem('seen_projects') || '[]')),
    isFetching: false,
    offsets: { trending: 0, search: {} },
    activeId: null
};

const feed = document.getElementById('feed');
const loader = document.getElementById('loader');

async function apiRequest(url) {
    try {
        const r = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(url));
        const j = await r.json();
        return JSON.parse(j.contents);
    } catch { return []; }
}

function extractHashtags(project) {
    const text = (project.description || '') + ' ' + (project.instructions || '');
    const tags = text.match(/#\w+/g) || [];
    return [...new Set(tags.map(t => t.toLowerCase().replace('#', '')))];
}

async function getRecommendedProjects() {
    if (state.isFetching) return [];
    state.isFetching = true;
    loader.style.display = 'block';

    const pool = [];
    const totalNeeded = parseInt(settings.loadAhead);
    
    // Algorithm logic: Search by liked tags or get trending
    const tagEntries = Object.entries(state.likedTags);
    if (tagEntries.length > 0) {
        const selectedTag = tagEntries[Math.floor(Math.random() * tagEntries.length)][0];
        const offset = state.offsets.search[selectedTag] || 0;
        const res = await apiRequest(`https://api.scratch.mit.edu/search/projects?q=${selectedTag}&limit=10&offset=${offset}`);
        if (res && res.length) {
            res.forEach(p => { p._algSource = `#${selectedTag}`; pool.push(p); });
            state.offsets.search[selectedTag] = offset + 10;
        }
    }

    const trending = await apiRequest(`https://api.scratch.mit.edu/explore/projects?limit=20&offset=${state.offsets.trending}&mode=trending`);
    state.offsets.trending += 20;
    if (trending && trending.length) {
        trending.forEach(p => { p._algSource = "Discovery"; pool.push(p); });
    }

    loader.style.display = 'none';
    state.isFetching = false;
    return pool.filter(p => p && p.id && !state.seen.has(p.id)).sort(() => Math.random() - 0.5);
}

function getIframeUrl(id) {
    if (settings.engine === 'turbowarp') {
        return `https://turbowarp.org/${id}/embed?autoplay=true&fps=30${settings.interpolation ? '&interpolate=true' : ''}`;
    } else if (settings.engine === 'penguinmod') {
        return `https://penguinmod.com/projects/${id}/embed?autoplay=true`;
    }
    return `https://scratch.mit.edu/projects/${id}/embed?autoplay=true`;
}

function createSlide(project) {
    const slide = document.createElement('div');
    slide.className = 'slide';
    slide.dataset.id = project.id;

    const pfpUrl = project.author.id 
        ? `https://uploads.scratch.mit.edu/get_image/user/${project.author.id}_60x60.png`
        : `https://cdn2.scratch.mit.edu/get_image/user/default_60x60.png`;

    slide.innerHTML = `
        <div class="project-container" id="container-${project.id}">
            <div class="algorithm-badge" style="display:${settings.hideBadges ? 'none' : 'block'}">${project._algSource || 'New'}</div>
            <div class="overlay">
                <div class="author-container">
                    <img class="pfp" src="${pfpUrl}" onerror="this.src='https://cdn2.scratch.mit.edu/get_image/user/default_60x60.png'" alt="">
                    <a href="https://scratch.mit.edu/users/${project.author.username}" target="_blank" class="author-tag">@${project.author.username}</a>
                </div>
                <div class="project-title">${project.title}</div>
            </div>
            <div class="side-bar">
                <!-- Interactive Like -->
                <button class="action-btn" onclick="handleLike(this, ${project.id})">
                    <div class="icon-circle">‚ù§Ô∏è</div>
                    <span class="action-label">Like</span>
                </button>
                
                <!-- Open Project (New) -->
                <button class="action-btn" onclick="window.open('https://scratch.mit.edu/projects/${project.id}', '_blank')">
                    <div class="icon-circle open-btn-icon">üöÄ</div>
                    <span class="action-label">View</span>
                </button>

                <!-- Share -->
                <button class="action-btn" onclick="shareProject(${project.id})">
                    <div class="icon-circle">‚ÜóÔ∏è</div>
                    <span class="action-label">Share</span>
                </button>

                <!-- Unclickable Stats -->
                <div class="stat-display">
                    <div class="stat-item">‚ù§Ô∏è ${num(project.stats?.loves || 0)}</div>
                    <div class="stat-item">‚≠ê ${num(project.stats?.favorites || 0)}</div>
                </div>
            </div>
        </div>
    `;

    slide.addEventListener('dblclick', e => { heart(e); handleLike(slide.querySelector('.action-btn'), project.id); });
    return slide;
}

function inject(id) {
    document.querySelectorAll('.project-container iframe').forEach(f => { f.src = 'about:blank'; f.remove(); });
    const c = document.getElementById(`container-${id}`);
    if (!c) return;
    const i = document.createElement('iframe');
    i.src = getIframeUrl(id);
    i.allow = 'fullscreen; autoplay';
    c.appendChild(i);
    state.activeId = id;
    state.seen.add(id);
    localStorage.setItem('seen_projects', JSON.stringify([...state.seen].slice(-200)));
}

const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
        const id = e.target.dataset.id;
        if (e.isIntersecting && e.intersectionRatio >= 0.5) {
            if (state.activeId !== id) inject(id);
        } else if (!e.isIntersecting) {
            const iframe = e.target.querySelector('iframe');
            if (iframe) { iframe.src = 'about:blank'; iframe.remove(); }
        }
    });
}, { threshold: [0, 0.5] });

async function loadMore() {
    const projects = await getRecommendedProjects();
    projects.forEach(p => {
        const s = createSlide(p);
        feed.appendChild(s);
        observer.observe(s);
    });
}

function scrollFeed(dir) {
    feed.scrollBy({ top: window.innerHeight * dir, behavior: 'smooth' });
}

async function handleLike(btn, projectId) {
    if (btn.dataset.liked) return;
    btn.dataset.liked = "true";
    btn.querySelector('.icon-circle').style.color = '#ff0050';
    const details = await apiRequest(`https://api.scratch.mit.edu/projects/${projectId}`);
    const tags = extractHashtags(details);
    tags.forEach(t => state.likedTags[t] = (state.likedTags[t] || 0) + 1);
    localStorage.setItem('liked_tags', JSON.stringify(state.likedTags));
}

function applyTheme() {
    document.body.className = `theme-${settings.theme}`;
}

function toggleSettings() {
    const panel = document.getElementById('settings-panel');
    panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    if (panel.style.display === 'flex') {
        document.getElementById('set-theme').value = settings.theme;
        document.getElementById('set-engine').value = settings.engine;
        document.getElementById('set-interp').checked = settings.interpolation;
        document.getElementById('set-hidebadges').checked = settings.hideBadges;
    }
}

function updateSetting(key, val) {
    settings[key] = val;
    localStorage.setItem('user_settings', JSON.stringify(settings));
    if (key === 'theme') applyTheme();
    if (['engine', 'interpolation'].includes(key)) {
        document.querySelectorAll('iframe').forEach(i => i.remove());
        state.activeId = null;
    }
}

function heart(e) {
    const h = document.createElement('div');
    h.className = 'heart-pop'; h.textContent = '‚ù§Ô∏è';
    h.style.left = e.clientX - 40 + 'px'; h.style.top = e.clientY - 40 + 'px';
    document.body.appendChild(h);
    setTimeout(() => h.remove(), 800);
}

function num(n) { return n >= 1000 ? (n/1000).toFixed(1)+'K' : n; }

function shareProject(id) {
    const el = document.createElement('textarea');
    el.value = `https://scratch.mit.edu/projects/${id}`;
    document.body.appendChild(el); el.select();
    document.execCommand('copy'); document.body.removeChild(el);
}

feed.addEventListener('scroll', () => {
    if (feed.scrollHeight - (feed.scrollTop + feed.clientHeight) < 1500) loadMore();
});

applyTheme();
loadMore();
</script>
</body>
</html>
